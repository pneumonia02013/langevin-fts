!--------------------------------------------------------------------
! The main program begins here
program block_copolymer_3d

  implicit none

#if USE_SINGLE_PRECISION == 1
  integer, parameter :: rp = selected_real_kind(6)
#else
  integer, parameter :: rp = selected_real_kind(15)
#endif
  real(kind=rp), parameter :: PI = 4.0d0 * atan(1.0d0)

  integer, parameter :: II = 3
  integer, parameter :: JJ = 4
  integer, parameter :: KK = 5
  integer, parameter :: NN = 4
  integer, parameter :: NNf = 2

  real(kind=rp) :: wa(II,JJ,KK), wb(II,JJ,KK)
  real(kind=rp) :: phia(II,JJ,KK), phib(II,JJ,KK)
  real(kind=rp) :: q1_init(II,JJ,KK), q2_init(II,JJ,KK)
  real(kind=rp) :: q1_last(II,JJ,KK), q2_last(II,JJ,KK)
  real(kind=rp) :: expdwa(II,JJ,KK), expdwb(II,JJ,KK)
  real(kind=rp) :: expdwa_half(II,JJ,KK), expdwb_half(II,JJ,KK)

  real(kind=rp) :: seg(II,JJ,KK)
  real(kind=rp) :: expfactor(0:II/2,0:JJ-1,0:KK-1)
  real(kind=rp) :: expfactor_half(0:II/2,0:JJ-1,0:KK-1)
  real(kind=rp) :: diff(II,JJ,KK)

  real(kind=rp) :: QQ, volume
  real(kind=rp) :: Lx, Ly, Lz, dx, dy, dz, ds
  real(kind=rp) :: xfactor, yfactor, zfactor, temp
  integer :: i, j, k

!-------------- initialize ------------
  write(*,*) "Initializing."
  
  ds = 1.0d0/NN
  Lx = 2.0d0
  Ly = 3.0d0
  Lz = 4.0d0

  dx = Lx/II
  dy = Ly/JJ
  dz = Lz/KK

  seg(:,:,:) = dx * dy * dz
  volume = Lx * Ly * Lz

! initialize pseudo spectral parameters
  wa=reshape((/0.183471406D+00,0.623968915D+00,0.731257661D+00,0.997228140D+00,0.961913696D+00, &
    0.792673860D-01,0.429684069D+00,0.290531312D+00,0.453270921D+00,0.199228629D+00, &
    0.754931905D-01,0.226924328D+00,0.936407886D+00,0.979392715D+00,0.464957186D+00, &
    0.742653949D+00,0.368019859D+00,0.885231224D+00,0.406191773D+00,0.653096157D+00, &
    0.567929080D-01,0.568028857D+00,0.144986181D+00,0.466158777D+00,0.573327733D+00, &
    0.136324723D+00,0.819010407D+00,0.271218167D+00,0.626224101D+00,0.398109186D-01, &
    0.860031651D+00,0.338153865D+00,0.688078522D+00,0.564682952D+00,0.222924187D+00, &
    0.306816449D+00,0.316316038D+00,0.640568415D+00,0.702342408D+00,0.632135481D+00, &
    0.649402777D+00,0.647100865D+00,0.370402133D+00,0.691313864D+00,0.447870566D+00, &
    0.757298851D+00,0.586173682D+00,0.766745717D-01,0.504185402D+00,0.812016428D+00, &
    0.217988206D+00,0.273487202D+00,0.937672578D+00,0.570540523D+00,0.409071185D+00, &
    0.391548274D-01,0.663478965D+00,0.260755447D+00,0.503943226D+00,0.979481790D+00/),(/II,JJ,KK/))

  wb=reshape((/0.113822903D-01,0.330673934D+00,0.270138412D+00,0.669606774D+00,0.885344778D-01, &
    0.604752856D+00,0.890062293D+00,0.328557615D+00,0.965824739D+00,0.865399960D+00, &
    0.698893686D+00,0.857947305D+00,0.594897904D+00,0.248187208D+00,0.155686710D+00, &
    0.116803898D+00,0.711146609D+00,0.107610460D+00,0.143034307D+00,0.123131521D+00, &
    0.230387237D+00,0.516274641D+00,0.562366089D-01,0.491449746D+00,0.746656140D+00, &
    0.296108614D+00,0.424987667D+00,0.651538750D+00,0.116745920D+00,0.567790110D+00, &
    0.954487190D+00,0.802476927D-01,0.440223916D+00,0.843025420D+00,0.612864528D+00, &
    0.571893767D+00,0.759625605D+00,0.872255004D+00,0.935065364D+00,0.635565347D+00, &
    0.373711972D-02,0.860683468D+00,0.186492706D+00,0.267880995D+00,0.579305501D+00, &
    0.693549226D+00,0.613843845D+00,0.259811620D-01,0.848915465D+00,0.766111508D+00, &
    0.872008750D+00,0.116289041D+00,0.917713893D+00,0.710076955D+00,0.442712526D+00, &
    0.516722213D+00,0.253395805D+00,0.472950065D-01,0.152934959D+00,0.292486174D+00/),(/II,JJ,KK/))

  expdwa(:,:,:) = exp(-wa(:,:,:)*ds*0.5d0)
  expdwb(:,:,:) = exp(-wb(:,:,:)*ds*0.5d0)
  expdwa_half(:,:,:) = exp(-wa(:,:,:)*ds*0.25d0)
  expdwb_half(:,:,:) = exp(-wb(:,:,:)*ds*0.25d0)

! calculate the exponential factor
  xfactor = -(2*PI/Lx)**2*ds/6.0d0
  yfactor = -(2*PI/Ly)**2*ds/6.0d0
  zfactor = -(2*PI/Lz)**2*ds/6.0d0

  do i=0,II/2
    do j=0,JJ-1
      do k=0,KK-1
        expfactor(i,j,k) = exp(i**2*xfactor+j**2*yfactor+k**2*zfactor)
        expfactor_half(i,j,k) = exp((i**2*xfactor+j**2*yfactor+k**2*zfactor)/2)
      end do
    end do
  end do

  call pseudo_cuda_initialize(expfactor, expfactor_half,  seg, volume, &
    II, JJ, KK, &
    NN, NNf, 256, 256, 0)

! q1 is q and q2 is qdagger in the note
! free end initial condition (q1 starts from A end)
  q1_init(:,:,:) = 1.0d0
! q2 starts from B end
  q2_init(:,:,:) = 1.0d0

!---------------- run --------------------
  write(*,*) "Running pseudo gpu."
  call pseudo_cuda_run(phia, phib, QQ,&
    q1_init,q2_init, &
    expdwa,expdwa_half, &
    expdwb,expdwb_half)

!--------------- check --------------------
  write(*,*) "Checking."
  write(*,*) "If error is less than 1.0e-7, it is ok!"
  call pseudo_get_partition(q1_last, q2_last)

  write(*,*) "q1_last", q1_last

  diff = q1_last-reshape((/ &
    0.651050966D+00,0.621430911D+00,0.635768980D+00, &
    0.586238610D+00,0.643540800D+00,0.619890246D+00, &
    0.572563766D+00,0.642836950D+00,0.577631856D+00, &
    0.578906269D+00,0.602596948D+00,0.575866916D+00, &
    0.605841597D+00,0.638724977D+00,0.660730257D+00, &
    0.641892780D+00,0.616824830D+00,0.667670935D+00, &
    0.644431757D+00,0.672493295D+00,0.679428105D+00, &
    0.622140852D+00,0.668463109D+00,0.645393312D+00, &
    0.565801207D+00,0.653541085D+00,0.614701494D+00, &
    0.571149925D+00,0.669685968D+00,0.616773571D+00, &
    0.558589651D+00,0.687912805D+00,0.612149131D+00, &
    0.574277498D+00,0.628111527D+00,0.600224403D+00, &
    0.570836561D+00,0.599711653D+00,0.553875945D+00, &
    0.598775883D+00,0.673375307D+00,0.560256384D+00, &
    0.652578842D+00,0.644971825D+00,0.587854083D+00, &
    0.592244004D+00,0.624478032D+00,0.641247730D+00, &
    0.591471982D+00,0.585449876D+00,0.557844621D+00, &
    0.665809411D+00,0.571854966D+00,0.594965115D+00, &
    0.617541046D+00,0.618098938D+00,0.652653564D+00, &
    0.652492268D+00,0.664067600D+00,0.629683861D+00/),(/II,JJ,KK/))
  write(*,*) "Partial Partition error:", sqrt(maxval(diff**2))

  diff = q2_last-reshape((/ &
    0.652440884D+00,0.588866522D+00,0.602986626D+00, &
    0.561760362D+00,0.566502383D+00,0.676791735D+00, &
    0.618155777D+00,0.648654315D+00,0.628823810D+00, &
    0.649964801D+00,0.667256753D+00,0.655606088D+00, &
    0.558398001D+00,0.572926104D+00,0.630520087D+00, &
    0.578813396D+00,0.632062147D+00,0.596723794D+00, &
    0.621316026D+00,0.620208540D+00,0.681640476D+00, &
    0.608192796D+00,0.661330680D+00,0.641937675D+00, &
    0.594813676D+00,0.667445195D+00,0.578216151D+00, &
    0.623797527D+00,0.622917192D+00,0.661063861D+00, &
    0.563737198D+00,0.666682020D+00,0.605445926D+00, &
    0.606533612D+00,0.672955584D+00,0.633062203D+00, &
    0.626225171D+00,0.607721821D+00,0.570177832D+00, &
    0.597097958D+00,0.600433561D+00,0.587609642D+00, &
    0.627671802D+00,0.608655586D+00,0.614971114D+00, &
    0.589282358D+00,0.636829220D+00,0.643733097D+00, &
    0.632490404D+00,0.584432787D+00,0.611491388D+00, &
    0.638912162D+00,0.565643909D+00,0.612107677D+00, &
    0.619807195D+00,0.665182633D+00,0.616948274D+00, &
    0.646990067D+00,0.634260213D+00,0.570190997D+00/),(/II,JJ,KK/))
  write(*,*) "Complementary Partial Partition error:", sqrt(maxval(diff**2))

  diff = phia(:,:,:)-reshape((/ &
    0.541576692D+00,0.476408710D+00,0.484510246D+00, &
    0.436458287D+00,0.455203069D+00,0.554186144D+00, &
    0.490008630D+00,0.534970465D+00,0.494860369D+00, &
    0.519157081D+00,0.544396011D+00,0.522889549D+00, &
    0.441966363D+00,0.457398296D+00,0.519491072D+00, &
    0.471976202D+00,0.514097303D+00,0.482867001D+00, &
    0.514602314D+00,0.509788968D+00,0.577445309D+00, &
    0.493650797D+00,0.554104807D+00,0.525006272D+00, &
    0.466326007D+00,0.555006738D+00,0.460198073D+00, &
    0.497891511D+00,0.511113077D+00,0.545183764D+00, &
    0.435000811D+00,0.557669488D+00,0.481068345D+00, &
    0.478904706D+00,0.547547701D+00,0.509959262D+00, &
    0.496408782D+00,0.482606799D+00,0.444184972D+00, &
    0.474832024D+00,0.495866727D+00,0.457824193D+00, &
    0.521493249D+00,0.491582421D+00,0.489759357D+00, &
    0.464118412D+00,0.511241357D+00,0.538053011D+00, &
    0.501742630D+00,0.458484291D+00,0.486026204D+00, &
    0.533460591D+00,0.438965248D+00,0.485884233D+00, &
    0.502900648D+00,0.547191345D+00,0.503235792D+00, &
    0.535656515D+00,0.521365219D+00,0.454226538D+00/),(/II,JJ,KK/))
  write(*,*) "Segment Concentration A error:", sqrt(maxval(diff**2))

  diff = phib(:,:,:)-reshape((/ &
    0.548439124D+00,0.498222000D+00,0.516368610D+00, &
    0.457048520D+00,0.515181968D+00,0.512495289D+00, &
    0.455861754D+00,0.529804197D+00,0.457743008D+00, &
    0.467867437D+00,0.493200338D+00,0.467621239D+00, &
    0.472444807D+00,0.505991504D+00,0.540935206D+00, &
    0.517104240D+00,0.493358156D+00,0.537291481D+00, &
    0.530108917D+00,0.547709095D+00,0.569423476D+00, &
    0.499580304D+00,0.556966525D+00,0.525227644D+00, &
    0.450230778D+00,0.542774801D+00,0.487127560D+00, &
    0.463613892D+00,0.545803220D+00,0.508056645D+00, &
    0.431580653D+00,0.573557059D+00,0.493184445D+00, &
    0.457098691D+00,0.514545035D+00,0.486879687D+00, &
    0.458692337D+00,0.468983689D+00,0.429770894D+00, &
    0.475216905D+00,0.544588844D+00,0.441682031D+00, &
    0.537003195D+00,0.519708819D+00,0.474498238D+00, &
    0.467688369D+00,0.504330224D+00,0.537799548D+00, &
    0.472963175D+00,0.455998332D+00,0.442482337D+00, &
    0.550631838D+00,0.438800457D+00,0.474513301D+00, &
    0.498932033D+00,0.509068347D+00,0.532194584D+00, &
    0.546104584D+00,0.546473283D+00,0.501427332D+00/),(/II,JJ,KK/))
  write(*,*) "Segment Concentration B error:", sqrt(maxval(diff**2))

!  do k = 1,KK
!    do j = 1,JJ
!      do i = 1,II
!        write(*,'(D15.9,A)',advance='no') phib(i,j,k),','
!      end do
!      write(*,*) '&'
!    end do
!  end do
!------------- finalize -------------
  write(*,*) "Finalize."
! finalize pseudo_spectral module
  call pseudo_cuda_finalize()

end program block_copolymer_3d
